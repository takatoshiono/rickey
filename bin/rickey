#!/usr/bin/env ruby

require 'Thor'
require 'rickey'
require 'rickey/iphoto'
require 'flickraw'
require 'dotenv'

class RickeyCommand < Thor
  desc 'show [albums|photos] --album [AlbumId]', 'Show iPhoto albums and photos.'
  method_option :album, type: :numeric, desc: 'Album id. This is required when showing photos'
  def show(target)
    p "This is show command. Target is '#{target}'"
    p options

    iphoto = Rickey::Iphoto.new(ENV['IPHOTO_LIBRARY_PATH'])

    case target
    when 'albums'
      # {"AlbumId"=>4, "AlbumName"=>"Photos", "Album Type"=>"99", "GUID"=>"allPhotosAlbum", "Master"=>true, "TransitionSpeed"=>1.0, "ShuffleSlides"=>false, "KeyList"=>["29", "1", "9", "3", "25", "19", "5", "13", "17", "21", "7", "23", "15", "27", "11"], "PhotoCount"=>15}
      iphoto.albums.each do |album|
        puts "id:#{album['AlbumId']}, count:#{album['PhotoCount']}, type:#{album['Album Type']}, name:#{album['AlbumName']}"
      end
    when 'photos'
      puts 'photos'
      unless options['album']
        puts '--album [AlbumId] required.'
        return
      end

      album = iphoto.album(id: options['album'])
      photos = iphoto.photos_by_ids(album['KeyList'])
      photos.each do |photo|
        # {"Caption"=>"IMG_5162", "Comment"=>" ", "GUID"=>"rRDHuaQoRvykMfcgqs7mAw", "Roll"=>8, "Rating"=>1, "ImagePath"=>"/Users/usr0600268/Pictures/iPhoto Library.photolibrary/Masters/2014/12/24/20141224-133908/IMG_5162.jpg", "MediaType"=>"Image", "ModDateAsTimerInterval"=>440262486.0, "DateAsTimerInterval"=>414846808.0, "DateAsTimerIntervalGMT"=>414879208.0, "MetaModDateAsTimerInterval"=>441161002.380927, "ThumbPath"=>"/Users/usr0600268/Pictures/iPhoto Library.photolibrary/Thumbnails/2014/12/24/20141224-133908/rRDHuaQoRvykMfcgqs7mAw/IMG_5162.jpg"}
        puts "caption: #{photo['Caption']}, rating: #{photo['Rating']}"
      end
    else
      puts 'Unkown subcommand.'
    end
  end

  desc 'tag [ratings]', 'Add rating tags for flickr photos'
  def tag(target)
    p "This is tag command. Target is '#{target}'"
    p options

    login_flickr

    photos = flickr.photos.search(
      user_id: 'me',
      text: 'CIMG1402',
    )

    p photos
  end

  def login_flickr
    FlickRaw.api_key = ENV['FLICKR_API_KEY']
    FlickRaw.shared_secret = ENV['FLICKR_API_SECRET']

    if ENV['FLICKR_ACCESS_TOKEN'] && ENV['FLICKR_ACCESS_SECRET']
      flickr.access_token = ENV['FLICKR_ACCESS_TOKEN']
      flickr.access_secret = ENV['FLICKR_ACCESS_SECRET']
      login = flickr.test.login
      puts "You are now authenticated as #{login.username}"
    else
      token = flickr.get_request_token
      auth_url = flickr.get_authorize_url(token['oauth_token'], perms: 'write')

      puts "Authorization url: #{auth_url}"
      ask 'Press any key to open:'
      `open '#{auth_url}'`
      verify = ask "Enter authorization code:"

      begin
        flickr.get_access_token(token['oauth_token'], token['oauth_token_secret'], verify)
        login = flickr.test.login
        puts "You are now authenticated as #{login.username} with token #{flickr.access_token} and secret #{flickr.access_secret}"
        append_to_dotenv(
          FLICKR_ACCESS_TOKEN: flickr.access_token,
          FLICKR_ACCESS_SECRET: flickr.access_secret,
        )
      rescue FlickRaw::FailedResponse => e
        puts "Authentication failed : #{e.msg}"
      end
    end
  end
end

def append_to_dotenv(settings)
  File.open('.env', 'a') do |f|
    settings.each do |k, v|
      f.puts "#{k.upcase}=#{v}"
    end
  end
end

Dotenv.load
RickeyCommand.start
